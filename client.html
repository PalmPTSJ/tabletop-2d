<!DOCTYPE html5>
<html>
	<head>
		<title>Hello</title>
        
        <meta charset="UTF-8" />
        
		<script src="lib/socket.io-1.4.5.js"></script>
		<script src="lib/jquery.js"></script>
        
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"> 
        
        <link rel="stylesheet" href="lib/materialize.min.css">
        <script src="lib/materialize.min.js"></script>

		<script src="gameObject.js"></script>
        <script src="components.js"></script>
        
        <style>
            #prefabList > * {
                cursor:pointer;
            }
        </style>
        
	</head>
	<body style="padding:0px 50px;">
    
        <div class="row">
            <div class="col m12 l8" style="">
				<div style="width:100%">
					<canvas id="gameCanvas" style="border:1px solid black;" tabindex="1">
				
					</canvas>
				</div>
            </div>
            <div class="col m12 l4">
                <div id="">
                    <h4>Console & Debug</h4>
                    <p id="debugCanvasPos"></p>
                    <p id="debugFPS"></p>
                    <div class="input-field">
                        <textarea id="debugConsole" style="height:150px" readonly></textarea>
                    </div>
                    <div class="input-field">
                        <input type="text" id="consoleInput"></input>
                        <label class="active" for="consoleInput">Console Input</label>
                    </div>
                </div>
				<div id="prefabListDiv">
					<h4>Prefab</h4>
                    <ul id="prefabList" class="collection">
                        
                    </ul>
				</div>
                <div id="objectListDiv">
					<h4>Object list</h4>
                    <ul id="objectList" class="collection">
                        
                    </ul>
				</div>
            </div>
        </div>
	</body>
    
    <!-- Include components -->
    <script src="components/Component.js"></script>
    
    <script src="components/ComponentTransform.js"></script>
    <script src="components/ComponentNetwork.js"></script>
    
    <script src="components/ComponentTabletopObject.js"></script>
    <script src="components/ComponentObjectInHand.js"></script>
    <script src="components/ComponentObjectStack.js"></script>
    
    <script src="components/ComponentCursorCollider.js"></script>
    
    <script src="components/ComponentRenderer.js"></script>
    <script src="components/ComponentImageRenderer.js"></script>
    <script src="components/ComponentRectRenderer.js"></script>
    <script src="components/ComponentTextRenderer.js"></script>
    <script src="components/ComponentImageRendererMulti.js"></script>
    <!-- End include components -->
    
	<script>
		var canvas = document.getElementById("gameCanvas");
		var ctx = canvas.getContext("2d");
		
		var objectList = [];
        var prefabList = {};
        
        var playerInfo = {};
        
        var fpsCount = 0;
        
        function getObjectFromId(id) {
            for(var obj of objectList) {
                if(obj.id == id) return obj;
            }
            return undefined;
        }
        function sortObjectList() { // Low Z -> High Z
            // sort
            console.log("Sort object")
            objectList.sort((a,b)=>{
                var ta = a.getComponent(ComponentTransform);
                var tb = b.getComponent(ComponentTransform);
                if(ta.pos.z < tb.pos.z) return -1;
                else if(ta.pos.z == tb.pos.z) return 0;
                return 1;
            })
        }
        
        function log(data) { // log to console
            var now = new Date();
            data = ("[" + now.getHours() + ':' + now.getMinutes() + ":" + now.getSeconds() + "] ") + data;
            $("#debugConsole").html(($("#debugConsole").html()+data+"\n").substr(-1000)); // last 1000 chars
        }
        
        var idGenerator = 0;
        function generateNewId() {
            // generate new id in form [Player id]_[Int]
            if(playerInfo.id === undefined) {
                console.log("Id generation request when playerInfo is not ready");
                return "GG";
            }
            return ""+playerInfo.id+"_"+(idGenerator++);
        }
		
        var ip = prompt("Please enter ip address","127.0.0.1:8080");
        
		var socket = io("ws://"+ip);

		socket.on('log',function (data) {
			console.log("Server log : ",data);
            log(data);
		});
        
        socket.on('newPrefab',function (data) {
            var prefab = new EmptyPrefab();
            prefab.fromJSON(data)
            prefabList[prefab.id] = prefab;
            
            // create new collection button
            var prefabCollection = document.createElement("li");
            prefabCollection.className = "collection-item";
            prefabCollection.innerHTML = prefab.name;
            prefabCollection.onclick = function() {
                // emit object create event
                var obj = createObjectFromPrefab(prefab);
                socket.emit("createObject",obj);
            }
            document.getElementById("prefabList").appendChild(prefabCollection);
        });
        
        socket.on('newObject',function(data) {
            var obj = new GameObject();
            obj.fromJSON(data);
            objectList.push(obj);
            sortObjectList();
        });
        
        socket.on('updateObject',function(data) {
            // update object of that id
            getObjectFromId(data.id).getComponent(ComponentNetwork).onNetworkUpdate(data);
            sortObjectList();
        });
        
        socket.on('deleteObject',function(id) {
            var obj = getObjectFromId(id);
            obj.onDestroy();
            if(selectingObject.has(obj)) selectingObject.delete(obj);
            objectList.splice(objectList.indexOf(obj));
        });
        
        socket.on('playerInfo',function(data) {
            playerInfo = data;
        });
		
        function createObjectFromPrefab(prefab) {
            var obj = prefab.instantiate();
            obj.getComponent(ComponentTransform).pos.x = canvasX + canvas.width/2;
            obj.getComponent(ComponentTransform).pos.y = canvasY + canvas.height/2;
            return obj;
        }
        
		function update(timestamp) {
            // setup canvas
            ctx.clearRect(0,0,canvas.width,canvas.height);
            
            canvas.width = $(canvas.parentNode).innerWidth();
            canvas.height = canvas.width / (4/3);
            $(canvas).css("width",canvas.width);
            $(canvas).css("height",canvas.height);
        
            ctx.save();
            ctx.translate(  -((canvasX+canvas.width/2)*canvasScale - canvas.width/2),
                            -((canvasY+canvas.height/2)*canvasScale - canvas.height/2));
            ctx.scale(canvasScale,canvasScale);
            $("#debugCanvasPos").html("Canvas position = "+Math.floor(canvasX)+","+Math.floor(canvasY)+" (scale "+Math.round(canvasScale*100)/100+")");
            // update every object
			for(var obj of objectList) obj.update(timestamp);
			
            ctx.restore();
            
            fpsCount++;
            
            window.requestAnimationFrame(update);
		}
		
		window.requestAnimationFrame(update);
		
		// canvas controller
        var canvasScale = 1;
        var canvasX = 0; // in default scale
        var canvasY = 0; // in default scale
        
        canvas.width = $(canvas.parentNode).innerWidth();
        canvas.height = canvas.width / (4/3);
        
        $(canvas).css("width",canvas.width);
        $(canvas).css("height",canvas.height);
        
		canvas.addEventListener("mousewheel", mouseWheelHandler, false);
		canvas.addEventListener("DOMMouseScroll", mouseWheelHandler, false);
        function mouseWheelHandler(e) {
            e.preventDefault();
            var e = window.event || e; // old IE support
            var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
            if(delta < 0) {
                canvasScale /= 1.25;
            }
            else {
                canvasScale *= 1.25;
            }
        }
        
        var mouseLastPos = {x:0,y:0,down:false};
        var selectingObject = new Set();
        canvas.addEventListener("mousedown",function (e) {
            mouseLastPos = {
                x           : e.pageX - $(canvas).offset().left,
                y           : e.pageY - $(canvas).offset().top,
                down        : true,
                move        : false,
                moveLength  : 0,
                isMovingObject : false
            }
            var clickPos = {
                x : canvasX + canvas.width/2 + (mouseLastPos.x-canvas.width/2)/canvasScale,
                y : canvasY + canvas.height/2 + (mouseLastPos.y-canvas.height/2)/canvasScale
            }
            for(var obj of selectingObject)
                if(obj.getEnabledComponent(ComponentCursorCollider) && obj.getEnabledComponent(ComponentCursorCollider).isOver(clickPos))
                    mouseLastPos.isMovingObject = true;
        });
        
        canvas.addEventListener("mousemove",function (e) {
            if(!mouseLastPos.down) return;
            var offX = e.pageX - $(canvas).offset().left - mouseLastPos.x;
            var offY = e.pageY - $(canvas).offset().top - mouseLastPos.y;
            if(mouseLastPos.isMovingObject) {
                for(var obj of selectingObject) {
                    obj.getComponent(ComponentTransform).pos.x += offX / canvasScale;
                    obj.getComponent(ComponentTransform).pos.y += offY / canvasScale;
                }
            }
            else {
                canvasX -= offX / canvasScale;
                canvasY -= offY / canvasScale;
            }
            mouseLastPos.x = e.pageX - $(canvas).offset().left;
            mouseLastPos.y = e.pageY - $(canvas).offset().top;
            mouseLastPos.move = true;
            mouseLastPos.moveLength += Math.abs(offX+offY) + mouseLastPos.moveLength;
        });
        
        canvas.addEventListener("mouseup",function (e) {
            mouseLastPos.down = false;
            var clickPos = {
                x : canvasX + canvas.width/2 + (mouseLastPos.x-canvas.width/2)/canvasScale,
                y : canvasY + canvas.height/2 + (mouseLastPos.y-canvas.height/2)/canvasScale
            }
            if(!mouseLastPos.isMovingObject && mouseLastPos.moveLength <= 5) { // click !
                if(!isKeyDown[16]) selectingObject.clear();
                for(var i = objectList.length-1;i >= 0;i--) { // Select from high Z to low Z item
                    var obj = objectList[i];
                    if(obj.getEnabledComponent(ComponentCursorCollider) && obj.getEnabledComponent(ComponentCursorCollider).isOver(clickPos)) {
                        // click on this object
                        selectingObject.add(obj);
                        break;
                    }
                }
            }
            if(mouseLastPos.isMovingObject) { // drop object
                // check if drop on top of something
                for(var i = objectList.length-1;i >= 0;i--) { // Select from high Z to low Z item
                    var obj = objectList[i];
                    if(selectingObject.has(obj)) continue;
                    if(obj.getEnabledComponent(ComponentCursorCollider) && obj.getEnabledComponent(ComponentCursorCollider).isOver(clickPos)) {
                        // drop item on this obj
                        obj.onObjectDrop(selectingObject);
                        break;
                    }
                }
            }
        });

        $(document).ready(function(){
            $('#consoleInput').keypress(function(e){
                if(e.keyCode==13) {
                    var cmd = $("#consoleInput").val();
                    $("#consoleInput").val("");
                    eval(cmd);
                }
                $('#linkadd').click();
            });
        });
        
        var isKeyDown = {};
        
        canvas.addEventListener("keydown",function (e) {
            e = e || window.event; 
            var charCode = e.charCode || e.keyCode;
            isKeyDown[charCode] = true;
        });
        
        canvas.addEventListener("keyup",function (e) {
            e = e || window.event; 
            var charCode = e.charCode || e.keyCode;
            isKeyDown[charCode] = false;
        });
        
        canvas.addEventListener("keypress",function (e) {
            e = e || window.event; 
            var charCode = e.charCode || e.keyCode;
            // call boardGameObject.keyPress
            for(var obj of selectingObject) {
                obj.onKeyPress(charCode);
            }
        });
        
        window.setInterval(()=>{
            $("#debugFPS").html("FPS : "+fpsCount);
            fpsCount = 0;
        },1000);
	
	</script>
</html>